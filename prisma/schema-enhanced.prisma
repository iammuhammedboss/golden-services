generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// AUDIT & SOFT DELETE MODELS
// ============================================

model AuditLog {
  id          String       @id @default(cuid())
  userId      String
  action      AuditAction
  entityType  String       // Table name
  entityId    String       // Record ID
  oldValues   Json?        // Before state
  newValues   Json?        // After state
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime     @default(now())
  user        User         @relation(fields: [userId], references: [id])

  @@index([entityType, entityId])
  @@index([userId, createdAt])
  @@index([createdAt])
  @@map("audit_logs")
}

model DeletedRecord {
  id          String          @id @default(cuid())
  entityType  String          // Table name
  entityId    String          // Original record ID
  data        Json            // Complete snapshot of deleted record
  deletedById String
  deletedAt   DateTime        @default(now())
  restoredAt  DateTime?
  restoredById String?
  deletedBy   User            @relation("DeletedBy", fields: [deletedById], references: [id])
  restoredBy  User?           @relation("RestoredBy", fields: [restoredById], references: [id])

  @@index([entityType, entityId])
  @@index([deletedAt])
  @@map("deleted_records")
}

// ============================================
// MASTER DATA MODELS
// ============================================

model ItemTypeMaster {
  id          String    @id @default(cuid())
  name        String    @unique // WINDOW, SOFA, CURTAIN, etc.
  category    String    // FURNITURE, TEXTILE, APPLIANCE, etc.
  description String?
  isActive    Boolean   @default(true)
  sortOrder   Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  deletedById String?

  @@map("item_type_masters")
}

model SofaTypeMaster {
  id          String    @id @default(cuid())
  name        String    @unique // TWO_SEATER, THREE_SEATER, L_SHAPE, etc.
  description String?
  isActive    Boolean   @default(true)
  sortOrder   Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  deletedById String?

  @@map("sofa_type_masters")
}

model WindowSizeMaster {
  id          String    @id @default(cuid())
  name        String    @unique // SMALL, MEDIUM, LARGE, CUSTOM
  dimensions  String?   // e.g., "3ft x 4ft"
  description String?
  isActive    Boolean   @default(true)
  sortOrder   Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  deletedById String?

  @@map("window_size_masters")
}

model RoomTypeMaster {
  id          String    @id @default(cuid())
  name        String    @unique // HALL, BEDROOM, KITCHEN, BATHROOM, etc.
  description String?
  isActive    Boolean   @default(true)
  sortOrder   Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  deletedById String?

  @@map("room_type_masters")
}

model PaymentMethodMaster {
  id          String    @id @default(cuid())
  name        String    @unique // CASH, CARD, BANK_TRANSFER, etc.
  description String?
  isActive    Boolean   @default(true)
  sortOrder   Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  deletedById String?

  @@map("payment_method_masters")
}

// ============================================
// ENHANCED CORE MODELS WITH SOFT DELETE
// ============================================

model Client {
  id               String        @id @default(cuid())
  name             String
  phone            String
  alternatePhone   String?
  whatsapp         String?
  email            String?
  type             ClientType    @default(INDIVIDUAL)
  isTemporary      Boolean       @default(false) // For "Cash Customer" etc.
  notes            String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  deletedAt        DateTime?
  deletedById      String?
  jobOrders        JobOrder[]
  quotations       Quotation[]
  siteVisits       SiteVisit[]
  sites            Site[]
  invoices         Invoice[]
  payments         Payment[]
  customerNotes    CustomerNote[]

  @@index([phone])
  @@index([deletedAt])
  @@map("clients")
}

model Lead {
  id                    String        @id @default(cuid())
  name                  String
  phone                 String
  whatsapp              String?
  email                 String?
  source                LeadSource
  serviceInterest       String?
  notes                 String?
  status                LeadStatus    @default(NEW)
  isTemporary           Boolean       @default(false)
  duplicateCheckIgnored Boolean       @default(false)
  createdById           String
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  deletedAt             DateTime?
  deletedById           String?
  createdBy             User          @relation(fields: [createdById], references: [id])
  quotations            Quotation[]
  siteVisits            SiteVisit[]

  @@index([phone])
  @@index([status])
  @@index([createdById])
  @@index([deletedAt])
  @@map("leads")
}

model Site {
  id          String      @id @default(cuid())
  clientId    String
  name        String
  address     String?
  city        String?
  locationUrl String?
  notes       String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  deletedAt   DateTime?
  deletedById String?
  jobOrders   JobOrder[]
  quotations  Quotation[]
  siteVisits  SiteVisit[]
  rooms       Room[]
  client      Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([deletedAt])
  @@map("sites")
}

// ============================================
// NEW MODELS FOR STRUCTURED MEASUREMENT
// ============================================

model Room {
  id              String            @id @default(cuid())
  siteVisitId     String
  siteId          String?
  roomType        String            // From RoomTypeMaster
  customName      String?           // "Room 1", "Master Bedroom", etc.
  notes           String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  deletedAt       DateTime?
  deletedById     String?
  siteVisit       SiteVisit         @relation(fields: [siteVisitId], references: [id], onDelete: Cascade)
  site            Site?             @relation(fields: [siteId], references: [id])
  items           RoomItem[]
  photos          Photo[]

  @@index([siteVisitId])
  @@index([siteId])
  @@index([deletedAt])
  @@map("rooms")
}

model RoomItem {
  id              String    @id @default(cuid())
  roomId          String
  itemType        String    // From ItemTypeMaster: WINDOW, SOFA, etc.
  subType         String?   // From SofaTypeMaster, WindowSizeMaster, etc.
  quantity        Int       @default(1)
  size            String?   // Dimensions or size descriptor
  dirtLevel       DirtLevel @default(MEDIUM)
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?
  deletedById     String?
  room            Room      @relation(fields: [roomId], references: [id], onDelete: Cascade)
  checklistItems  ChecklistItem[]

  @@index([roomId])
  @@index([deletedAt])
  @@map("room_items")
}

model SiteVisit {
  id               String            @id @default(cuid())
  leadId           String?
  clientId         String?
  siteId           String?
  scheduledAt      DateTime
  completedAt      DateTime?
  status           SiteVisitStatus   @default(SCHEDULED)
  visitType        VisitType         @default(FULL_HOUSE)
  assignedToId     String
  notes            String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  deletedAt        DateTime?
  deletedById      String?
  measurementItems MeasurementItem[]
  rooms            Room[]
  photos           Photo[]
  assignedTo       User              @relation(fields: [assignedToId], references: [id])
  client           Client?           @relation(fields: [clientId], references: [id])
  lead             Lead?             @relation(fields: [leadId], references: [id])
  site             Site?             @relation(fields: [siteId], references: [id])

  @@index([assignedToId])
  @@index([clientId])
  @@index([leadId])
  @@index([siteId])
  @@index([deletedAt])
  @@map("site_visits")
}

model MeasurementItem {
  id          String      @id @default(cuid())
  siteVisitId String
  type        String
  sizeLabel   String?
  description String?
  quantity    Int         @default(1)
  dirtLevel   DirtLevel   @default(MEDIUM)
  notes       String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  deletedAt   DateTime?
  deletedById String?
  siteVisit   SiteVisit   @relation(fields: [siteVisitId], references: [id], onDelete: Cascade)

  @@index([siteVisitId])
  @@index([deletedAt])
  @@map("measurement_items")
}

model Photo {
  id           String       @id @default(cuid())
  siteVisitId  String?
  jobOrderId   String?
  roomId       String?
  phase        PhotoPhase
  url          String
  description  String?
  uploadedById String
  createdAt    DateTime     @default(now())
  deletedAt    DateTime?
  deletedById  String?
  jobOrder     JobOrder?    @relation(fields: [jobOrderId], references: [id])
  room         Room?        @relation(fields: [roomId], references: [id])
  siteVisit    SiteVisit?   @relation(fields: [siteVisitId], references: [id])
  uploadedBy   User         @relation(fields: [uploadedById], references: [id])

  @@index([siteVisitId])
  @@index([jobOrderId])
  @@index([roomId])
  @@index([deletedAt])
  @@map("photos")
}

// ============================================
// QUOTATION MODELS
// ============================================

model Quotation {
  id          String          @id @default(cuid())
  clientId    String
  siteId      String?
  leadId      String?
  version     Int             @default(1) // Multiple versions per client
  createdById String
  status      QuotationStatus @default(DRAFT)
  validUntil  DateTime?
  notes       String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  deletedAt   DateTime?
  deletedById String?
  jobOrders   JobOrder[]
  items       QuotationItem[]
  invoices    Invoice[]
  client      Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdBy   User            @relation(fields: [createdById], references: [id])
  lead        Lead?           @relation(fields: [leadId], references: [id])
  site        Site?           @relation(fields: [siteId], references: [id])

  @@index([clientId])
  @@index([status])
  @@index([deletedAt])
  @@map("quotations")
}

model QuotationItem {
  id          String     @id @default(cuid())
  quotationId String
  serviceId   String?
  description String
  quantity    Decimal    @db.Decimal(10, 2)
  unit        String
  unitPrice   Decimal    @db.Decimal(10, 3)
  total       Decimal    @db.Decimal(10, 3)
  optionGroup String?
  createdAt   DateTime   @default(now())
  deletedAt   DateTime?
  quotation   Quotation  @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  service     Service?   @relation(fields: [serviceId], references: [id])

  @@index([quotationId])
  @@index([deletedAt])
  @@map("quotation_items")
}

// ============================================
// JOB ORDER MODELS WITH CHECKLIST
// ============================================

model JobOrder {
  id                 String               @id @default(cuid())
  quotationId        String?
  clientId           String
  siteId             String
  jobNumber          String               @unique
  status             JobOrderStatus       @default(SCHEDULED)
  scheduledDate      DateTime             @db.Date
  scheduledStartTime DateTime?
  scheduledEndTime   DateTime?
  isMultiDay         Boolean              @default(false)
  endDate            DateTime?            @db.Date
  materialsRequired  String?              // JSON or Text
  machineryRequired  String?              // JSON or Text
  notes              String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  deletedAt          DateTime?
  deletedById        String?
  assignments        JobAssignment[]
  client             Client               @relation(fields: [clientId], references: [id], onDelete: Cascade)
  quotation          Quotation?           @relation(fields: [quotationId], references: [id])
  site               Site                 @relation(fields: [siteId], references: [id], onDelete: Cascade)
  statusUpdates      JobStatusUpdate[]
  photos             Photo[]
  invoices           Invoice[]
  checklistItems     ChecklistItem[]

  @@index([status])
  @@index([scheduledDate])
  @@index([clientId])
  @@index([deletedAt])
  @@map("job_orders")
}

model ChecklistItem {
  id              String    @id @default(cuid())
  jobOrderId      String
  roomItemId      String?   // Link to RoomItem if from measurement
  description     String
  isCompleted     Boolean   @default(false)
  completedAt     DateTime?
  completedById   String?
  photoRequired   Boolean   @default(true)
  photoUrl        String?
  notes           String?
  sortOrder       Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?
  deletedById     String?
  jobOrder        JobOrder  @relation(fields: [jobOrderId], references: [id], onDelete: Cascade)
  roomItem        RoomItem? @relation(fields: [roomItemId], references: [id])
  completedBy     User?     @relation(fields: [completedById], references: [id])

  @@index([jobOrderId])
  @@index([isCompleted])
  @@index([deletedAt])
  @@map("checklist_items")
}

model JobAssignment {
  id         String     @id @default(cuid())
  jobOrderId String
  userId     String
  roleInJob  JobRole    @default(CLEANER)
  createdAt  DateTime   @default(now())
  deletedAt  DateTime?
  jobOrder   JobOrder   @relation(fields: [jobOrderId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([jobOrderId, userId])
  @@index([userId])
  @@index([deletedAt])
  @@map("job_assignments")
}

model JobStatusUpdate {
  id              String            @id @default(cuid())
  jobOrderId      String
  createdById     String
  status          JobProgressStatus
  progressPercent Int               @default(0)
  note            String?
  createdAt       DateTime          @default(now())
  createdBy       User              @relation(fields: [createdById], references: [id])
  jobOrder        JobOrder          @relation(fields: [jobOrderId], references: [id], onDelete: Cascade)

  @@index([jobOrderId])
  @@index([createdAt])
  @@map("job_status_updates")
}

// ============================================
// INVOICE & PAYMENT MODELS
// ============================================

model Invoice {
  id                  String        @id @default(cuid())
  invoiceNumber       String        @unique
  clientId            String
  jobOrderId          String?
  quotationId         String?
  issueDate           DateTime      @default(now())
  dueDate             DateTime?
  status              InvoiceStatus @default(DRAFT)
  currency            String        @default("OMR")
  subtotal            Decimal       @db.Decimal(10, 3)
  tax                 Decimal       @default(0) @db.Decimal(10, 3)
  total               Decimal       @db.Decimal(10, 3)
  pdfUrl              String?       // Stored PDF path
  sharedViaWhatsApp   Boolean       @default(false)
  sharedAt            DateTime?
  notes               String?
  createdById         String
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  deletedAt           DateTime?
  deletedById         String?
  items               InvoiceItem[]
  payments            Payment[]
  client              Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdBy           User          @relation(fields: [createdById], references: [id])
  jobOrder            JobOrder?     @relation(fields: [jobOrderId], references: [id])
  quotation           Quotation?    @relation(fields: [quotationId], references: [id])

  @@index([status])
  @@index([clientId])
  @@index([deletedAt])
  @@map("invoices")
}

model InvoiceItem {
  id          String   @id @default(cuid())
  invoiceId   String
  description String
  quantity    Decimal  @db.Decimal(10, 2)
  unitPrice   Decimal  @db.Decimal(10, 3)
  total       Decimal  @db.Decimal(10, 3)
  createdAt   DateTime @default(now())
  deletedAt   DateTime?
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([deletedAt])
  @@map("invoice_items")
}

model Payment {
  id              String    @id @default(cuid())
  invoiceId       String
  clientId        String
  amount          Decimal   @db.Decimal(10, 3)
  paymentMethod   String    // From PaymentMethodMaster
  paymentDate     DateTime  @default(now())
  referenceNumber String?
  notes           String?
  recordedById    String
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?
  deletedById     String?
  invoice         Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  client          Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  recordedBy      User      @relation(fields: [recordedById], references: [id])

  @@index([invoiceId])
  @@index([clientId])
  @@index([paymentDate])
  @@index([deletedAt])
  @@map("payments")
}

// ============================================
// ADDITIONAL MODELS
// ============================================

model CustomerNote {
  id          String    @id @default(cuid())
  clientId    String
  leadId      String?
  jobOrderId  String?
  content     String
  isReminder  Boolean   @default(false)
  reminderDate DateTime?
  createdById String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  deletedById String?
  client      Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdBy   User      @relation(fields: [createdById], references: [id])

  @@index([clientId])
  @@index([createdById])
  @@index([reminderDate])
  @@index([deletedAt])
  @@map("customer_notes")
}

model ServiceCategory {
  id          String    @id @default(cuid())
  name        String
  description String?
  sortOrder   Int       @default(0)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  deletedById String?
  services    Service[]

  @@index([deletedAt])
  @@map("service_categories")
}

model Service {
  id           String               @id @default(cuid())
  categoryId   String
  name         String
  slug         String               @unique
  description  String?
  isActive     Boolean              @default(true)
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  deletedAt    DateTime?
  deletedById  String?
  quoteItems   QuotationItem[]
  pricingRules ServicePricingRule[]
  category     ServiceCategory      @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([categoryId])
  @@index([deletedAt])
  @@map("services")
}

model ServicePricingRule {
  id          String      @id @default(cuid())
  serviceId   String
  pricingType PricingType
  unitLabel   String
  basePrice   Decimal     @db.Decimal(10, 3)
  currency    String      @default("OMR")
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  deletedAt   DateTime?
  deletedById String?
  service     Service     @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([serviceId])
  @@index([deletedAt])
  @@map("service_pricing_rules")
}

model Role {
  id          String     @id @default(cuid())
  name        String     @unique
  description String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  deletedAt   DateTime?
  deletedById String?
  users       UserRole[]

  @@index([deletedAt])
  @@map("roles")
}

model UserRole {
  userId String
  roleId String
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@map("user_roles")
}

model User {
  id                 String            @id @default(cuid())
  name               String
  email              String            @unique
  phone              String?
  whatsapp           String?
  hashedPassword     String
  isActive           Boolean           @default(true)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  deletedAt          DateTime?
  deletedById        String?
  jobAssignments     JobAssignment[]
  statusUpdates      JobStatusUpdate[]
  leads              Lead[]
  photos             Photo[]
  quotations         Quotation[]
  siteVisits         SiteVisit[]
  roles              UserRole[]
  invoices           Invoice[]
  payments           Payment[]
  customerNotes      CustomerNote[]
  checklistItems     ChecklistItem[]
  auditLogs          AuditLog[]
  deletedRecords     DeletedRecord[]   @relation("DeletedBy")
  restoredRecords    DeletedRecord[]   @relation("RestoredBy")

  @@index([email])
  @@index([deletedAt])
  @@map("users")
}

// ============================================
// ENUMS
// ============================================

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  RESTORE
  LOGIN
  LOGOUT
}

enum ClientType {
  INDIVIDUAL
  COMPANY
}

enum DirtLevel {
  LIGHT
  MEDIUM
  HEAVY
}

enum JobOrderStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum JobProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  ON_HOLD
  COMPLETED
}

enum JobRole {
  SUPERVISOR
  CLEANER
  TECHNICIAN
  DRIVER
  OTHER
}

enum LeadSource {
  WEBSITE
  WHATSAPP
  INSTAGRAM
  PHONE_CALL
  WALK_IN
  REFERRAL
  OTHER
}

enum LeadStatus {
  NEW
  CONTACTED
  SITE_VISIT_SCHEDULED
  QUOTED
  WON
  LOST
}

enum PhotoPhase {
  BEFORE
  DURING
  AFTER
}

enum PricingType {
  PER_UNIT
  PER_SQM
  PER_HOUR
  PER_VISIT
  LUMP_SUM
}

enum QuotationStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
}

enum SiteVisitStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
}

enum VisitType {
  FULL_HOUSE
  SPECIFIC_SERVICE
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  PARTIALLY_PAID
  OVERDUE
  CANCELLED
}
