generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Client {
  id          String        @id @default(cuid())
  name        String
  phone       String
  whatsapp    String?
  email       String?
  type        ClientType    @default(INDIVIDUAL)
  notes       String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  jobOrders   JobOrder[]
  quotations  Quotation[]
  siteVisits  SiteVisit[]
  sites       Site[]
  invoices    Invoice[]

  @@map("clients")
}

model JobAssignment {
  id         String     @id @default(cuid())
  jobOrderId String
  userId     String
  roleInJob  JobRole    @default(CLEANER)
  createdAt  DateTime   @default(now())
  jobOrder   JobOrder   @relation(fields: [jobOrderId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([jobOrderId, userId])
  @@map("job_assignments")
}

model JobOrder {
  id                 String               @id @default(cuid())
  quotationId        String?
  clientId           String
  siteId             String
  jobNumber          String               @unique
  status             JobOrderStatus       @default(SCHEDULED)
  scheduledDate      DateTime             @db.Date
  scheduledStartTime DateTime?
  scheduledEndTime   DateTime?
  notes              String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  assignments        JobAssignment[]
  client             Client               @relation(fields: [clientId], references: [id], onDelete: Cascade)
  quotation          Quotation?           @relation(fields: [quotationId], references: [id])
  site               Site                 @relation(fields: [siteId], references: [id], onDelete: Cascade)
  statusUpdates      JobStatusUpdate[]
  photos             Photo[]
  invoices           Invoice[]

  @@map("job_orders")
}

model JobStatusUpdate {
  id              String            @id @default(cuid())
  jobOrderId      String
  createdById     String
  status          JobProgressStatus
  progressPercent Int               @default(0)
  note            String?
  createdAt       DateTime          @default(now())
  createdBy       User              @relation(fields: [createdById], references: [id])
  jobOrder        JobOrder          @relation(fields: [jobOrderId], references: [id], onDelete: Cascade)

  @@map("job_status_updates")
}

model Lead {
  id              String        @id @default(cuid())
  name            String
  phone           String
  whatsapp        String?
  email           String?
  source          LeadSource
  serviceInterest String?
  notes           String?
  status          LeadStatus    @default(NEW)
  createdById     String
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  createdBy       User          @relation(fields: [createdById], references: [id])
  quotations      Quotation[]
  siteVisits      SiteVisit[]

  @@map("leads")
}

model MeasurementItem {
  id          String      @id @default(cuid())
  siteVisitId String
  type        String
  sizeLabel   String?
  description String?
  quantity    Int         @default(1)
  dirtLevel   DirtLevel   @default(MEDIUM)
  notes       String?
  createdAt   DateTime    @default(now())
  siteVisit   SiteVisit   @relation(fields: [siteVisitId], references: [id], onDelete: Cascade)

  @@map("measurement_items")
}

model Photo {
  id           String       @id @default(cuid())
  siteVisitId  String?
  jobOrderId   String?
  phase        PhotoPhase
  url          String
  description  String?
  uploadedById String
  createdAt    DateTime     @default(now())
  jobOrder     JobOrder?    @relation(fields: [jobOrderId], references: [id])
  siteVisit    SiteVisit?   @relation(fields: [siteVisitId], references: [id])
  uploadedBy   User         @relation(fields: [uploadedById], references: [id])

  @@map("photos")
}

model QuotationItem {
  id          String     @id @default(cuid())
  quotationId String
  serviceId   String?
  description String
  quantity    Decimal    @db.Decimal(10, 2)
  unit        String
  unitPrice   Decimal    @db.Decimal(10, 3)
  total       Decimal    @db.Decimal(10, 3)
  optionGroup String?
  createdAt   DateTime   @default(now())
  quotation   Quotation  @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  service     Service?   @relation(fields: [serviceId], references: [id])

  @@map("quotation_items")
}

model Quotation {
  id          String          @id @default(cuid())
  clientId    String
  siteId      String?
  leadId      String?
  createdById String
  status      QuotationStatus @default(DRAFT)
  validUntil  DateTime?
  notes       String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  jobOrders   JobOrder[]
  items       QuotationItem[]
  invoices    Invoice[]
  client      Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdBy   User            @relation(fields: [createdById], references: [id])
  lead        Lead?           @relation(fields: [leadId], references: [id])
  site        Site?           @relation(fields: [siteId], references: [id])

  @@map("quotations")
}

model Role {
  id          String     @id @default(cuid())
  name        String     @unique
  description String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  users       UserRole[]

  @@map("roles")
}

model ServiceCategory {
  id          String    @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  services    Service[]

  @@map("service_categories")
}

model ServicePricingRule {
  id          String      @id @default(cuid())
  serviceId   String
  pricingType PricingType
  unitLabel   String
  basePrice   Decimal     @db.Decimal(10, 3)
  currency    String      @default("OMR")
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  service     Service     @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@map("service_pricing_rules")
}

model Service {
  id           String               @id @default(cuid())
  categoryId   String
  name         String
  slug         String               @unique
  description  String?
  isActive     Boolean              @default(true)
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  quoteItems   QuotationItem[]
  pricingRules ServicePricingRule[]
  category     ServiceCategory      @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@map("services")
}

model SiteVisit {
  id               String            @id @default(cuid())
  leadId           String?
  clientId         String?
  siteId           String?
  scheduledAt      DateTime
  status           SiteVisitStatus   @default(SCHEDULED)
  assignedToId     String
  notes            String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  measurementItems MeasurementItem[]
  photos           Photo[]
  assignedTo       User              @relation(fields: [assignedToId], references: [id])
  client           Client?           @relation(fields: [clientId], references: [id])
  lead             Lead?             @relation(fields: [leadId], references: [id])
  site             Site?             @relation(fields: [siteId], references: [id])

  @@map("site_visits")
}

model Site {
  id          String      @id @default(cuid())
  clientId    String
  name        String
  address     String?
  city        String?
  locationUrl String?
  notes       String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  jobOrders   JobOrder[]
  quotations  Quotation[]
  siteVisits  SiteVisit[]
  client      Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("sites")
}

model UserRole {
  userId String
  roleId String
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@map("user_roles")
}

model User {
  id                 String            @id @default(cuid())
  name               String
  email              String            @unique
  phone              String?
  whatsapp           String?
  hashedPassword     String
  isActive           Boolean           @default(true)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  jobAssignments     JobAssignment[]
  statusUpdates      JobStatusUpdate[]
  leads              Lead[]
  photos             Photo[]
  quotations         Quotation[]
  siteVisits         SiteVisit[]
  roles              UserRole[]
  invoices           Invoice[]

  @@map("users")
}

model Invoice {
  id             String        @id @default(cuid())
  invoiceNumber  String        @unique
  clientId       String
  jobOrderId     String?
  quotationId    String?
  issueDate      DateTime      @default(now())
  dueDate        DateTime?
  status         InvoiceStatus @default(DRAFT)
  currency       String        @default("OMR")
  subtotal       Decimal       @db.Decimal(10, 3)
  tax            Decimal       @default(0) @db.Decimal(10, 3)
  total          Decimal       @db.Decimal(10, 3)
  notes          String?
  createdById    String
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  items          InvoiceItem[]
  client         Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdBy      User          @relation(fields: [createdById], references: [id])
  jobOrder       JobOrder?     @relation(fields: [jobOrderId], references: [id])
  quotation      Quotation?    @relation(fields: [quotationId], references: [id])

  @@map("invoices")
}

model InvoiceItem {
  id          String   @id @default(cuid())
  invoiceId   String
  description String
  quantity    Decimal  @db.Decimal(10, 2)
  unitPrice   Decimal  @db.Decimal(10, 3)
  total       Decimal  @db.Decimal(10, 3)
  createdAt   DateTime @default(now())
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("invoice_items")
}

enum ClientType {
  INDIVIDUAL
  COMPANY
}

enum DirtLevel {
  LIGHT
  MEDIUM
  HEAVY
}

enum JobOrderStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum JobProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  ON_HOLD
  COMPLETED
}

enum JobRole {
  SUPERVISOR
  CLEANER
  TECHNICIAN
  OTHER
}

enum LeadSource {
  WEBSITE
  WHATSAPP
  INSTAGRAM
  PHONE_CALL
  REFERRAL
  OTHER
}

enum LeadStatus {
  NEW
  CONTACTED
  SITE_VISIT_SCHEDULED
  QUOTED
  WON
  LOST
}

enum PhotoPhase {
  BEFORE
  DURING
  AFTER
}

enum PricingType {
  PER_UNIT
  PER_SQM
  PER_HOUR
  PER_VISIT
  LUMP_SUM
}

enum QuotationStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
}

enum SiteVisitStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}